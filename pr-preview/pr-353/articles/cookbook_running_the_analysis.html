<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Running the Analysis • pacta.multi.loanbook</title>
<link rel="icon" type="image/png" sizes="16x16" href="/headshot_placeholder.png">
<link rel="icon" type="image/png" sizes="32x32" href="/headshot_placeholder.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="/headshot_placeholder.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Overpass-0.4.9/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Running the Analysis">
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-info" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">pacta.multi.loanbook</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Unreleased version">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Cookbook</h6></li>
    <li><a class="dropdown-item" href="../articles/cookbook_overview.html">Overview</a></li>
    <li><a class="dropdown-item" href="../articles/cookbook_preparatory_steps.html">Preparatory Steps</a></li>
    <li><a class="dropdown-item" href="../articles/cookbook_running_the_analysis.html">Running the Analysis</a></li>
    <li><a class="dropdown-item" href="../articles/cookbook_interpretation.html">Interpretation of Results</a></li>
    <li><a class="dropdown-item" href="../articles/cookbook_advanced_use_cases.html">Advanced Use Cases</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Documentation</h6></li>
    <li><a class="dropdown-item" href="../articles/config_yml.html">Configuring the application</a></li>
    <li><a class="dropdown-item" href="../articles/data_dictionary.html">Understanding the data</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Methodology</h6></li>
    <li><a class="dropdown-item" href="../articles/company_alignment_metric.html">Calculation of a company alignment metric</a></li>
    <li><a class="dropdown-item" href="../articles/loanbook_aggregated_alignment_metric.html">Calculation of exposure-weighted aggregated alignment metric</a></li>
    <li><a class="dropdown-item" href="../articles/sector_split.html">Splitting loans of multi sector companies</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-packages" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Packages</button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-packages">
<li><a class="external-link dropdown-item" href="https://rmi-pacta.github.io/r2dii.data">r2dii.data</a></li>
    <li><a class="external-link dropdown-item" href="https://rmi-pacta.github.io/r2dii.match">r2dii.match</a></li>
    <li><a class="external-link dropdown-item" href="https://rmi-pacta.github.io/r2dii.analysis">r2dii.analysis</a></li>
    <li><a class="external-link dropdown-item" href="https://rmi-pacta.github.io/r2dii.plot">r2dii.plot</a></li>
    <li><a class="dropdown-item" href="https://rmi-pacta.github.io/pacta.multi.loanbook">pacta.multi.loanbook</a></li>
  </ul>
</li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/RMI-PACTA/pacta.multi.loanbook/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Running the Analysis</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/RMI-PACTA/pacta.multi.loanbook/blob/safer-way-to-get-filename-from-path/vignettes/cookbook_running_the_analysis.Rmd" class="external-link"><code>vignettes/cookbook_running_the_analysis.Rmd</code></a></small>
      <div class="d-none name"><code>cookbook_running_the_analysis.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="running-the-analysis">Running the Analysis<a class="anchor" aria-label="anchor" href="#running-the-analysis"></a>
</h2>
<p>This section provides a step-by-step guide to running the PACTA for
Supervisors analysis using the <code>pacta.multi.loanbook</code>
package. It includes information on the structure of the workflow, the
required functions, and the interpretation of the results.</p>
<div class="section level3">
<h3 id="structure-of-the-workflow">Structure of the Workflow<a class="anchor" aria-label="anchor" href="#structure-of-the-workflow"></a>
</h3>
<p>The PACTA for Supervisors analysis consists of four main steps:</p>
<ul>
<li>Data preparation: Preparing the input data sets for the requirements
of the analysis.</li>
<li>Matching process: Matching the raw loan books to the ABCD data and
validating the matches manually.</li>
<li>Prioritization of loan books: Selecting the correct matches for
further analysis and diagnosing match success and coverage
statistics</li>
<li>Run PACTA for Supervisors analysis: Running the analysis based on
the parameters set in the <code>config.yml</code> file to generate the
production-based alignment analysis.</li>
</ul>
<p>The following diagram illustrates the structure of the workflow:</p>
<div class="figure" style="text-align: center">
<img src="../reference/figures/p4s_workflow_structure.png" alt="Fig. 1: Structure of the Workflow" width="200px"><p class="caption">
Fig. 1: Structure of the Workflow
</p>
</div>
<p>As the diagram shows, there is a logical sequence to how to run the
functions. For any of the functions to work, the previous functions must
have been run already and their outputs must be accessible as inputs to
the next functions. If you want to keep different versions of the
calculations, i.e. you want to avoid overwriting past outputs, you will
have to (1) ensure that each run is done with a new value for the
corresponding output directory set in the <code>config.yml</code> and
(2) that the relevant function refers to the appropriate directories of
upstream outputs. For example, if you want to run the analysis twice and
keep both results, all <code>dir_*</code> entries of the
<code>config.yml</code> should remain identical for both runs, except
for the <code>dir_analysis</code> entry, which should be different for
each run.</p>
<p>The following sub sections will provide detailed information on each
of the steps of the analysis, starting with a brief explanation of the
setup, as each of the functions will require the path to the
<code>config.yml</code> file as an input argument.</p>
</div>
<div class="section level3">
<h3 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h3>
<p>If you run PACTA for Supervisors interactively or from a script you
may have prepared, you will likely want to load the
<code>pacta.multi.loanbook</code> package and save the path to the
<code>config.yml</code> file in a variable first:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rmi-pacta.github.io/pacta.multi.loanbook/">pacta.multi.loanbook</a></span><span class="op">)</span></span>
<span><span class="va">config_path</span> <span class="op">&lt;-</span> <span class="st">"path/to/config.yml"</span></span></code></pre></div>
<p>This allows you passing the relevant config information easily to
each of the four main functions.</p>
</div>
<div class="section level3">
<h3 id="data-preparation">Data preparation<a class="anchor" aria-label="anchor" href="#data-preparation"></a>
</h3>
<p>The first step of the analysis is to prepare your input data sets for
the requirements of the analysis. Your ABCD data will need to be
prepared and you can optionally use a custom sector split, that will
also need to be prepared. The relevant function is
<code><a href="../reference/prepare_abcd.html">prepare_abcd()</a></code>, which takes configurations from the
<code>config.yml</code> that you have prepared. The function will store
intermediary files in the directory that you have indicated as the value
corresponding to the key <code>dir_prepared_abcd</code> in the
<code>config.yml</code>. This step only has to be run once for an
analysis. You can run this function as follows:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pacta.multi.loanbook</span><span class="fu">::</span><span class="fu"><a href="../reference/prepare_abcd.html">prepare_abcd</a></span><span class="op">(</span><span class="va">config_path</span><span class="op">)</span></span></code></pre></div>
<div class="section level4">
<h4 id="options-for-the-prepare_abcd-function">Options for the <code>prepare_abcd()</code> function<a class="anchor" aria-label="anchor" href="#options-for-the-prepare_abcd-function"></a>
</h4>
<p>The <code><a href="../reference/prepare_abcd.html">prepare_abcd()</a></code> function has a number of options that
can be set in the <code>config.yml</code> file. These options
include:</p>
<ul>
<li>
<code class="sourceCode yaml"><span class="at">remove_inactive_companies</span></code>:
whether or not inactive companies should be removed from the ABCD data
(For more information on the options available, see the <a href="https://rmi-pacta.github.io/pacta.multi.loanbook/articles/config_yml.html#prepare_abcd">relevant
section on preparing the ABCD</a> in the
<code><a href="../articles/config_yml.html">vignette("config_yml")</a></code>.)</li>
<li>
<code class="sourceCode yaml"><span class="at">sector_split</span></code>: if
and how a company sector split should be applied in the calculations
(For more information on the options available, see the <a href="https://rmi-pacta.github.io/pacta.multi.loanbook/articles/config_yml.html#sector_split">relevant
section on the sector split</a> in the
<code><a href="../articles/config_yml.html">vignette("config_yml")</a></code>). Additionally, see the
documentation of the sector split methodology in
<code><a href="../articles/sector_split.html">vignette("sector_split")</a></code>.</li>
</ul>
</div>
<div class="section level4">
<h4 id="sector-split">Sector split<a class="anchor" aria-label="anchor" href="#sector-split"></a>
</h4>
<p>If you want to use the sector split, you can specify which company
identifiers the split should be applied on by providing a CSV file with
the company identifiers in the <code>split_company_ids.csv</code> file
in the input directory. The file should contain the columns
<code>company_id</code> and <code>name_company</code> to identify the
relevant companies. Before deciding to apply the sector split, it is
strongly recommended to read the documentation on the sector split in
<code><a href="../articles/sector_split.html">vignette("sector_split")</a></code> first.</p>
</div>
</div>
<div class="section level3">
<h3 id="matching-process">Matching process<a class="anchor" aria-label="anchor" href="#matching-process"></a>
</h3>
<p>The next step in the analysis is to run the matching process.
Assuming you have prepared the raw loan books as explained in <a href="https://rmi-pacta.github.io/pacta.multi.loanbook/articles/cookbook_preparatory_steps.html#raw-loan-books">the
section on preparing the input data sets</a>, you can now use the
<code><a href="../reference/match_loanbooks.html">match_loanbooks()</a></code> function. This will read the raw loan
books from your inputs and attempt to match them to the prepared ABCD
data from the previous step. The function will store matched loan book
files in a directory that you have indicated as the value corresponding
to the key <code>dir_matched_loanbooks</code> in the
<code>config.yml</code>. You can run this function as follows:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pacta.multi.loanbook</span><span class="fu">::</span><span class="fu"><a href="../reference/match_loanbooks.html">match_loanbooks</a></span><span class="op">(</span><span class="va">config_path</span><span class="op">)</span></span></code></pre></div>
<p>After the matching process is complete, you will need to do some
manual matching. This means that you will need to manually inspect the
suggested matches that the tool has found and decide which ones to keep
or to remove. This is especially important when using text based
matching, as there is no guarantee that similar company names as
identified by the algorithms will actually refer to the same companies
in the raw loan books and the ABCD. Thus, a manual validation step is
crucial in the analysis, as the quality of the matches will determine
the quality of the results of any further calculations.</p>
<p>The manual matching process is not automated and will require some
time and effort on your part. You can find the matched loan books in the
directory that you have specified as <a href="https://rmi-pacta.github.io/pacta.multi.loanbook/articles/config_yml.html#dir_matched_loanbooks">the
<code>dir_matched_loanbooks</code> parameter in the
<code>config.yml</code> file</a>. The matched loan books will be stored
in CSV files, one for each raw loan book. You can open these files in a
spreadsheet program to verify the matches. Importantly, you will need to
make a copy for each of the matched loan book files in the same
directory and rename that copy by adding the suffix <code>_manual</code>
to the file name. The following steps of the analysis expect this
pattern, so it is important to follow this naming convention.</p>
<p>You can find more detailed information about the matching process in
the <a href="https://pacta.rmi.org/pacta-for-banks-2020/" class="external-link">training
material on the PACTA for Banks website</a> in the section “PACTA for
Banks Training Webinar 2” and in the <a href="https://pacta.rmi.org/wp-content/uploads/2020/12/PACTA-for-Banks-Training-Webinar-2-Matching-a-loan-book-to-physical-assets-in-the-real-economy-.pdf" class="external-link">corresponding
slide deck</a>.</p>
<div class="section level4">
<h4 id="some-expectations-for-the-matching-process">Some expectations for the matching process<a class="anchor" aria-label="anchor" href="#some-expectations-for-the-matching-process"></a>
</h4>
<ul>
<li>It is unlikely that you will be able to match all of the loans from
your raw loan books to the ABCD data set. This is expected and has the
following reasons:
<ul>
<li>Raw loan books often include companies that are not in scope of the
PACTA analysis, for example there may be companies active in the
financial sector or in manufacturing of IT products. Both these sectors
are fully out of scope. There may also be companies that are active in
upstream or downstream activities of the sectors covered by PACTA. This
means that the company activities are not at the part of the value chain
that is covered by PACTA and accordingly the companies are not matched.
Examples for this are power distribution companies or companies that
manufacture aircrafts.</li>
<li>The ABCD data set may not cover all companies that are in scope of
the PACTA analysis. While coverage of the real economy sectors is
usually rather high in the data sets that are commonly used for PACTA,
there are gaps. This implies that some in-scope companies cannot be
matched because the ABCD data set does not include them. Advanced users
may research the production profiles of such companies by themselves and
add them to the ABCD data manually, however this is a very involved
process and not standard procedure and will therefore not be covered in
this cookbook.</li>
<li>If you are using sector classifications for the matching process
(which is recommended whenever possible), some matches may not be
identified in case the companies in the raw loan book are misclassified.
For example, if a utility that is focused on coal-fired power generation
is classified as a coal mining company, the matching function will not
suggest a match.</li>
</ul>
</li>
<li>Given that it is unlikely to match all loans, it is recommended to
try and match the companies with the largest financial exposures first,
as this ensures the best possible financial coverage of the loan book in
the analysis.</li>
<li>It is also recommended to run multiple iterations of the matching
process, potentially adjusting the matching parameters in the
<code>config.yml</code> file, to see if you can improve the match
success rate. The match success rate can be obtained based on the
manually validated matched loan books and the raw loan books as
described in <a href="#prioritization-of-loan-books-match-success-and-coverage-diagnostics">the
next section on prioritization and diagnostics</a>.</li>
</ul>
</div>
<div class="section level4">
<h4 id="options-for-the-match_loanbooks-function">Options for the <code>match_loanbooks()</code> function<a class="anchor" aria-label="anchor" href="#options-for-the-match_loanbooks-function"></a>
</h4>
<p>The <code><a href="../reference/match_loanbooks.html">match_loanbooks()</a></code> function has a number of options
that can be set in the <code>config.yml</code> file. These options
include:</p>
<ul>
<li>
<code class="sourceCode yaml"><span class="at">params_match_name</span></code>:
multiple options to specify the approach to matching the raw loan book
with the ABCD <a href="https://rmi-pacta.github.io/pacta.multi.loanbook/articles/config_yml.html#matching">relevant
section on matching</a> in the <code><a href="../articles/config_yml.html">vignette("config_yml")</a></code>).
Note that these parameters are all based on the
<code><a href="https://rmi-pacta.github.io/r2dii.match/reference/match_name.html" class="external-link">r2dii.match::match_name</a></code> function and pass the parameters
directly to that function. For more information on the options
available, see the <a href="https://rmi-pacta.github.io/r2dii.match/reference/match_name.html" class="external-link">documentation
of the r2dii.match package</a>. This also covers matching based on
unique identifiers, which is the most reliable way to match companies,
but requires that both the raw loan books and the ABCD contain such
identifiers.</li>
<li>
<code class="sourceCode yaml"><span class="at">manual_sector_classification</span></code>:
whether to use a manually prepared sector classification system for
matching the loan books to in-scope PACTA sectors, see the <a href="https://rmi-pacta.github.io/pacta.multi.loanbook/articles/config_yml.html#matching">relevant
section on matching</a> in the <code><a href="../articles/config_yml.html">vignette("config_yml")</a></code>), or
not. If there is no need to use a manually prepared sector
classification file, the sector classification systems provided in
<code><a href="https://rmi-pacta.github.io/r2dii.data/reference/sector_classifications.html" class="external-link">r2dii.data::sector_classifications</a></code> can be used, which
currently cover the following sector classifications: GICS, ISIC, NACE,
NAICS, PSIC, SIC. If it is not possible to map the loans in your loan
books to any of these systems, you can prepare your own mapping file
that follows the same structure as the sector classification files in
<code><a href="https://rmi-pacta.github.io/r2dii.data/reference/sector_classifications.html" class="external-link">r2dii.data::sector_classifications</a></code> and use the config file
to instruct the code to use this file for matching. Note that this will
only be a promising approach if the classifications you are using are
sufficiently granular to map to PACTA sectors without excessive
ambiguity.</li>
</ul>
</div>
<div class="section level4">
<h4 id="addressing-misclassfied-loans">Addressing misclassfied loans<a class="anchor" aria-label="anchor" href="#addressing-misclassfied-loans"></a>
</h4>
<p>There are two ways to appropriately handle misclassified loans that
are identified as in-scope in the raw data set but are then not
matched.</p>
<ol style="list-style-type: decimal">
<li>Correct the classification in the raw loan book and re-run the
matching process. If the loan was clearly mis-classified, this may be
the most appropriate way to handle the issue. It may be a good idea to
record any such changes made in the input data though. The upside of
this approach is that the loan will now either be matched correctly, as
it will be assigned the sector that the company should have and
therefore find an entry in the ABCD data set to match against. Or, if
there is still no match to be found in the ABCD, the loan will correctly
be missing in the appropriate sector and therefore indicate a lower
match success rate where it should.</li>
<li>If a manual re-classification of the raw loan book is not possible
or desired, the calculation of the match success rate can be corrected
by adding a file <code>loans_to_remove.csv</code> to the input
directory. This file should include the columns <code>id_loan</code> and
<code>group_id</code> to indicate the precise mis-classified loan and
the loan book in which it was found. This combination of loan and loan
book will then be excluded from the match success calculation.</li>
</ol>
<p>The reason why it is a good idea to either correct mis-classified
loans or disregard them in the calculation of the match success rate is
that a mis-classified loan cannot possibly be matched in a given sector.
Therefore, no amount of work would be sufficient to improve the sector
match success rate, because it is calculated against an incorrect
baseline. Technically, the user is not forced to correct
misclassifications, and there may be a limit to how much time should be
spent on this, but it is recommended to at least correct large
mis-classified loans.</p>
</div>
<div class="section level4">
<h4 id="sector-split-1">Sector split<a class="anchor" aria-label="anchor" href="#sector-split-1"></a>
</h4>
<p>If you want to apply the sector split to the loan books, you should
keep all relevant sectors in the matched loan book, instead of only one
sector. This is because the sector split will be applied to the matched
loan books, and the sector split will be based on the sectors in the
matched loan books. If you only keep one sector in the matched loan
books, the sector split will not be applied correctly and may wrongly
appear to reduce overall matched financial exposure. The sector split
will be applied to the matched loan books in the next step of the
analysis.</p>
</div>
</div>
<div class="section level3">
<h3 id="prioritization-of-loan-books-match-success-and-coverage-diagnostics">Prioritization of loan books; Match success and coverage
diagnostics<a class="anchor" aria-label="anchor" href="#prioritization-of-loan-books-match-success-and-coverage-diagnostics"></a>
</h3>
<p>The next step is to prioritize the manually verified matched loan
books and analyze their coverage, both relative to the raw loan book
inputs (the “match success rate”) and to the production capacity in the
wider economy (the “loan book production coverage”). Prioritizing the
loan books means that you will only keep the best identified match for
each loan and use that in the following steps of the analysis.</p>
<p>You will probably want to check the status of your loan book and
production coverage several times, as it is rare to get to the desired
level of matching in one iteration (see the corresponding <a href="https://rmi-pacta.github.io/pacta.multi.loanbook/articles/cookbook_interpretation.html#coverage-diagnostics">“Coverage
Diagnostics” section</a> in the next chapter for more details on how to
interpret the coverage values). This means you may want to repeat the
previous step (<a href="#matching-process">matching the loan books</a>,
likely using different parameters for different iterations) and this
step (prioritizing the matched loan books and analyzing their match
success rate) a number of times to reach the best possible outcome. To
prioritize your matched loan books and calculate the coverage
diagnostics, you will use the <code><a href="../reference/prioritise_and_diagnose.html">prioritise_and_diagnose()</a></code>
function. This call will store matched prioritized loan book files and
coverage diagnostics in a directory that you have indicated as the value
corresponding to the key
<code>dir_prioritized_loanbooks_and_diagnostics</code> in the
<code>config.yml</code>. You can run the function as follows:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pacta.multi.loanbook</span><span class="fu">::</span><span class="fu"><a href="../reference/prioritise_and_diagnose.html">prioritise_and_diagnose</a></span><span class="op">(</span><span class="va">config_path</span><span class="op">)</span></span></code></pre></div>
<div class="section level4">
<h4 id="options-for-the-prioritise_and_diagnose-function">Options for the <code>prioritise_and_diagnose()</code> function<a class="anchor" aria-label="anchor" href="#options-for-the-prioritise_and_diagnose-function"></a>
</h4>
<p>The <code><a href="../reference/prioritise_and_diagnose.html">prioritise_and_diagnose()</a></code> function has a number of
options that can be set in the <code>config.yml</code> file. These
options include:</p>
<ul>
<li>
<code class="sourceCode yaml"><span class="at">priority</span></code>: the
option to set a specific order for prioritizing the matches. This is an
option that is passed directly to the
<code><a href="https://rmi-pacta.github.io/r2dii.match/reference/prioritize.html" class="external-link">r2dii.match::prioritize</a></code> function. <code>NULL</code> is a
valid default value and is usually a setting that works well, at least
as a starting point. For more information, see the <a href="https://rmi-pacta.github.io/pacta.multi.loanbook/articles/config_yml.html#match_prioritize">relevant
section on the prioritization of matched loan books</a> in the
<code><a href="../articles/config_yml.html">vignette("config_yml")</a></code> or the <a href="https://rmi-pacta.github.io/r2dii.match/reference/prioritize.html" class="external-link">documentation
of the r2dii.match::prioritize() function here</a>.</li>
<li>
<code class="sourceCode yaml"><span class="at">by_group</span></code>: by
which variables to group the loan books to produce grouped results of
the analysis. This parameter is used across multiple steps of the
analysis, both in the diagnostics and in the analysis. This is because
it slices and/or aggregates the loan books such that the analysis will
produce results along the indicated dimension. If no <code class="sourceCode yaml"><span class="at">by_group</span></code>
parameter is passed (i.e. <code class="sourceCode yaml"><span class="ch">NULL</span></code>), all loan
books will be aggregated. Otherwise, loan books can either be kept
separate (<code class="sourceCode yaml"><span class="at">group_id</span></code>) or
grouped by any other variable that is provided in each of the raw loan
books. Although <code class="sourceCode yaml"><span class="at">by_group</span></code> is
considered a project parameter mainly relevant to the main section of
the analysis it does affect the split of the prioritzed loan books and
how their coverage metrics are returned, so it is good to be aware of
this parameter at this point. See the <a href="https://rmi-pacta.github.io/pacta.multi.loanbook/articles/config_yml.html#by_group">relevant
section on the <code>by_group</code> parameter in the documentation of
the <code>config.yml</code> file</a>.</li>
</ul>
</div>
</div>
<div class="section level3">
<h3 id="run-pacta-for-supervisors-analysis">Run PACTA for Supervisors analysis<a class="anchor" aria-label="anchor" href="#run-pacta-for-supervisors-analysis"></a>
</h3>
<p>The final step is running the analysis based on the parameters you
have set in the <code>config.yml</code> file. This entails both a
standard PACTA for Banks analysis and the calculation of the net
aggregate alignment metric. For both parts of the analysis, outputs will
be stored in the sub-directories <code>../standard/</code> (for standard
PACTA for Banks results) and <code>../aggregated/</code> for the net
aggregate alignment metric directory - below the directory that you have
indicated as the value corresponding to the key
<code>dir_analysis</code> in the <code>config.yml</code>. Outputs in
these sub directories will comprise tabular outputs and plots. To run
the analysis on all of your previously matched and prioritized loan
books, you will use the <code><a href="../reference/analyse.html">analyse()</a></code> function as follows:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pacta.multi.loanbook</span><span class="fu">::</span><span class="fu"><a href="../reference/analyse.html">analyse</a></span><span class="op">(</span><span class="va">config_path</span><span class="op">)</span></span></code></pre></div>
<div class="section level4">
<h4 id="options-for-the-analysis-function-and-the-overall-analysis">Options for the <code>analysis()</code> function and the overall
analysis<a class="anchor" aria-label="anchor" href="#options-for-the-analysis-function-and-the-overall-analysis"></a>
</h4>
<p>The <code>analysis()</code> function has a number of options that can
be set in the <code>config.yml</code> file. These options include:</p>
<ul>
<li>
<code class="sourceCode yaml"><span class="at">scenario_source</span></code>:
which source should be used for allocating climate transition scenario
pathways to the companies and loan books. This refers to the relevant
scenario publication and usually contains the name and the year of the
publication, e.g.: <code class="sourceCode yaml"><span class="st">"weo_2023"</span></code>
or <code class="sourceCode yaml"><span class="st">"geco_2023"</span></code>.</li>
<li>
<code class="sourceCode yaml"><span class="at">scenario_select</span></code>:
which scenario should be used for reference in the net aggregate
alignment metric. This must be a scenario that is included in the <code class="sourceCode yaml"><span class="at">scenario_source</span></code>
indicated above.</li>
<li>
<code class="sourceCode yaml"><span class="at">region_select</span></code>:
which region to use as a reference for the analysis. This will filter
the underlying production capacity to assets in the relevant region and
will measure alignment against the scenario trajectory for the relevant
region. It must therefore be a region, for which scenario data is
available in the source selected above. Note that usually, <code class="sourceCode yaml"><span class="st">"global"</span></code>
is also a valid region.</li>
<li>
<code class="sourceCode yaml"><span class="at">start_year</span></code>: the
start year of the analysis. This must be a year that is available both
in the ABCD data and for which the scenario data has been prepared. The
loan book data is assumed to be a snapshot of the end of the same
year.</li>
<li>
<code class="sourceCode yaml"><span class="at">time_frame</span></code>: the
time frame of the analysis, which refers to the number of forward
looking years after the start year that are to be considered in the
alignment analysis. Usually this time frame is set to 5 years.
Specifically, it must be a time frame for which scenario data values and
ABCD data values are available for all sectors that are to be analyzed.
There are not many cases, in which it is expected to change the time
frame to something else than its default value of 5 years.</li>
<li>
<code class="sourceCode yaml"><span class="at">by_group</span></code>: by
which variables to group the loan books to produce grouped results of
the analysis. This parameter is used across multiple steps of the
analysis, both in the diagnostics and in the analysis. This is because
it slices and/or aggregates the loan books such that the analysis will
produce results along the indicated dimension. If no <code class="sourceCode yaml"><span class="at">by_group</span></code>
parameter is passed (i.e. <code class="sourceCode yaml"><span class="ch">NULL</span></code>), all loan
books will be aggregated. Otherwise, loan books can either be kept
separate (<code class="sourceCode yaml"><span class="at">group_id</span></code>) or
grouped by any other variable that is provided in each of the raw loan
books.</li>
</ul>
<p>All these options are documented in more detail the <a href="https://rmi-pacta.github.io/pacta.multi.loanbook/articles/config_yml.html#project_parameters">section
on project parameters</a> in the
<code><a href="../articles/config_yml.html">vignette("config_yml")</a></code>.</p>
<p>Usually, it will be interesting to run the analysis for more than one
<a href="https://rmi-pacta.github.io/pacta.multi.loanbook/articles/config_yml.html#by_group"><code>by_group</code>
value</a>, possibly also for multiple combinations of the other
parameters. You will therefore have to run the analysis as many times as
there are combinations of interest that you wish to generate results
for. If you do this, you should take into account that running the same
<code>pacta.multi.loanbooks</code> function multiple times with
different parameters will overwrite the results of the previous run if
you do not use new output directories for each run. This is why it is
recommended to <a href="https://rmi-pacta.github.io/pacta.multi.loanbook/articles/config_yml.html#directories">set
up a new output directory</a> in the <code>config.yml</code> file for
each run of the analysis, if you want to keep the results of multiple
runs so that you can compare the outcomes based on different parameters.
The last chapter <a href="https://rmi-pacta.github.io/pacta.multi.loanbook/articles/cookbook_advanced_use_cases.html">“Advanced
Use Cases”</a> describes how you could go about that process in more
detail. However, it is recommended going through the standard process of
the analysis completely once, before approaching more advanced use
cases.</p>
<p><strong>PREVIOUS CHAPTER:</strong> <a href="cookbook_preparatory_steps.html">Preparatory Steps</a></p>
<p><strong>NEXT CHAPTER:</strong> <a href="cookbook_interpretation.html">Interpretation of Results</a></p>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><!-- begin footer --><div class="footer">
    <div class="container">
        <div class="row start top-4 bottom-8">
            <div class="col-2"> <img id="footerlogo" src="../rmi_logo_stacked_tag_white.svg" alt="RMI logo">
</div>
            <div class="col-10">
                <div class="row">
                    <div class="col-md-4 col-xs-6">
                        <a href="https://pacta.rmi.org/" target="_blank" class="external-link"><div class="icon fa fa-link"></div></a>
                        <a href="https://github.com/RMI-PACTA" target="_blank" class="external-link"><div class="icon fab fa-github"></div></a>
                        <a href="https://twitter.com/RockyMtnInst" target="_blank" class="external-link"><div class="icon fab fa-twitter"></div></a>
                        <a href="https://www.linkedin.com/showcase/rmi-pacta/" target="_blank" class="external-link"><div class="icon fab fa-linkedin-in"></div></a>
                    </div>
                </div>
                    <div class="col-md-4 col-xs-12">
                        <h5 class="bottom-2"></h5>

                        <p>© RMI</p>

                    </div>
                </div>
            </div>
        </div>
    </div>
</footer>
</div>
<!-- / end footer -->

    
   





  </body>
</html>
